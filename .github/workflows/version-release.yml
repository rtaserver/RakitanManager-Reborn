name: Sync Version and Create Release

on:
  push:
    paths:
      - 'version'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  sync_and_release:
    runs-on: ubuntu-latest
    outputs:
      changelog: ${{ steps.changelog.outputs.CHANGELOG }}
    env:
      INDEX_FILE: rakitanmanager/web/index.php
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Read version file
        id: read_version
        run: |
          version=$(grep -E '^version=' version | cut -d'=' -f2- | tr -d '\r\n')
          lastupdate=$(grep -E '^lastupdate=' version | cut -d'=' -f2- | tr -d '\r\n')
          if [ -z "$version" ]; then
            echo "No version found in 'version' file" >&2
            exit 1
          fi
          echo "VERSION=$version" >> $GITHUB_ENV
          echo "LASTUPDATE=$lastupdate" >> $GITHUB_ENV
          echo "Read version: $version, lastupdate: $lastupdate"

      - name: Update `index.php` with version
        id: update_index
        run: |
          file="${INDEX_FILE}"
          version="${VERSION}"
          last="${LASTUPDATE}"
          if [ ! -f "$file" ]; then
            echo "Index file not found: $file" >&2
            exit 1
          fi
          # Replace $currentVersion and $updatelast lines (keeps formatting)
          perl -0777 -pe "s/\$currentVersion\s*=\s*'[^']*';/\$currentVersion = '${version}';/s" -i "$file"
          perl -0777 -pe "s/\$updatelast\s*=\s*'[^']*';/\$updatelast = '${last}';/s" -i "$file"

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          if [ -n "$(git status --porcelain)" ]; then
            git add "$file"
            git commit -m "Sync: update index.php to version ${version}"
            git push
            echo "changed=true" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Add changelog info to new release description
        id: changelog
        shell: bash
        run: |
          r=$(awk '/^\*\*Changelog\*\*/ {if(found) exit; found=1} found' CHANGELOG.md)
          r="${r//'%'/'%25'}"
          r="${r//$'\n'/'%0A'}"
          r="${r//$'\r'/'%0D'}"  
          echo "CHANGELOG=$r" >> $GITHUB_OUTPUT

      - name: Create GitHub Release
        uses: actions/create-release@v1
        with:
          tag_name: v${{ env.VERSION }}
          release_name: "RakitanManager v${{ env.VERSION }}"
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
